<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fatlin AI - Sincronización FATLA</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { background-color: #0F172A; margin: 0; font-family: system-ui, -apple-system, sans-serif; overflow-x: hidden; }
        * { -webkit-tap-highlight-color: transparent; }
        
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-15px); } }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulse-fast { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(5px); } 75% { transform: translateX(-5px); } }
        
        .animate-float { animation: float 4s ease-in-out infinite; }
        .animate-spin-slow { animation: spin-slow 15s linear infinite; transform-origin: center; }
        .animate-pulse-fast { animation: pulse-fast 1s infinite; }
        .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@lucide/web"></script>

    <script type="module">
        import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.FB = { 
            initializeApp, getApps, getAuth, signInAnonymously, 
            signInWithCustomToken, onAuthStateChanged, 
            getFirestore, doc, setDoc, getDoc 
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        const API_KEY = ""; // El entorno proporciona la clave en tiempo de ejecución
        const MODEL_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'fatla-ai-v4';
        const MAX_LIVES = 5;
        const REGEN_TIME_SECONDS = 90;
        const GOAL_PER_LEVEL = 15;

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "",
            authDomain: "fatla-ai.firebaseapp.com",
            projectId: "fatla-ai",
            storageBucket: "fatla-ai.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abc123"
        };

        const fallbackQuestions = [
            { q: "¿Qué significa la sigla PACIE?", options: ["Presencia, Alcance, Capacitación, Interacción, Elearning", "Plataforma, Aula, Comunidad, Internet, Estudiantes", "Pasos, Acciones, Contenidos, Ideas, Evaluación", "Procesos, Ambientes, Conocimiento, Interacción, Ética"], correct: 0 },
            { q: "En la fase de ALCANCE, ¿cuál es el enfoque principal?", options: ["Instalar Moodle", "Planificar objetivos pedagógicos y tecnológicos", "Decorar el aula virtual", "Enviar correos a los alumnos"], correct: 1 },
            { q: "¿Cuál es el propósito del Bloque de Cierre en un EVA?", options: ["Eliminar el curso", "Negociación y retroalimentación", "Solo poner la nota final", "Hacer publicidad de otros cursos"], correct: 1 },
            { q: "¿Qué fase de PACIE busca evitar el abandono mediante la motivación constante?", options: ["Presencia", "Interacción", "Capacitación", "Tecnología"], correct: 1 },
            { q: "¿Cuál es el sitio oficial de la Fundación para la Actualización Tecnológica de Latinoamérica?", options: ["www.google.com", "www.facebook.com", "www.fatla.org", "www.learning.com"], correct: 2 }
        ];

        const LucideIcon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-block' }}></i>;
        };

        const FatlinMascot = ({ className = "", isCorrect = null }) => (
            <div className={`relative ${className}`}>
                <div className={`absolute inset-0 blur-[40px] rounded-full transition-colors duration-700 ${
                    isCorrect === true ? 'bg-green-500/30' : 
                    isCorrect === false ? 'bg-red-500/30' : 
                    'bg-orange-500/20'
                }`} />
                <svg viewBox="0 0 200 200" className="w-full h-full relative z-10 drop-shadow-2xl animate-float">
                    <defs>
                        <linearGradient id="robotBody" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stopColor="#334155" />
                            <stop offset="100%" stopColor="#0f172a" />
                        </linearGradient>
                        <linearGradient id="scanLaser" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stopColor="transparent" />
                            <stop offset="50%" stopColor={isCorrect === true ? "#22c55e" : isCorrect === false ? "#ef4444" : "#f97316"} />
                            <stop offset="100%" stopColor="transparent" />
                        </linearGradient>
                    </defs>
                    <circle cx="100" cy="100" r="95" fill="none" stroke="#f97316" strokeWidth="0.5" strokeDasharray="5,10" className="opacity-20 animate-spin-slow" />
                    <path d="M40 70 Q40 30 100 30 T160 70 L160 130 Q160 170 100 170 T40 130 Z" fill="url(#robotBody)" stroke="#475569" strokeWidth="2" />
                    <rect x="55" y="75" width="90" height="45" rx="10" fill="#020617" stroke="#1e293b" strokeWidth="2" />
                    <g clipPath="inset(0 0 0 0 round 10px)">
                        <rect x="55" y="75" width="20" height="45" fill="url(#scanLaser)">
                            <animateTransform attributeName="transform" type="translate" from="-30 0" to="110 0" dur="2s" repeatCount="indefinite" />
                        </rect>
                        <g className="animate-pulse-fast">
                            <rect x="75" y="92" width="12" height="12" rx="2" fill={isCorrect === true ? "#22c55e" : isCorrect === false ? "#ef4444" : "#f97316"} className="opacity-80" />
                            <rect x="113" y="92" width="12" height="12" rx="2" fill={isCorrect === true ? "#22c55e" : isCorrect === false ? "#ef4444" : "#f97316"} className="opacity-80" />
                        </g>
                    </g>
                    <line x1="80" y1="30" x2="70" y2="10" stroke="#475569" strokeWidth="3" strokeLinecap="round" />
                    <circle cx="70" cy="10" r="4" fill="#f97316" className="animate-pulse" />
                    <line x1="120" y1="30" x2="130" y2="10" stroke="#475569" strokeWidth="3" strokeLinecap="round" />
                    <circle cx="130" cy="10" r="4" fill="#f97316" className="animate-pulse" />
                </svg>
            </div>
        );

        function App() {
            const [user, setUser] = useState(null);
            const [gameState, setGameState] = useState('landing');
            const [questionPool, setQuestionPool] = useState(fallbackQuestions);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isLoading, setIsLoading] = useState(false);
            const [feedback, setFeedback] = useState(null);
            const [selectedIdx, setSelectedIdx] = useState(null);
            const [timeLeft, setTimeLeft] = useState(0);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            
            const [progress, setProgress] = useState({
                level: 1, score: 0, lives: MAX_LIVES, 
                questionsCorrectInCurrentLevel: 0, 
                lastLifeLost: null
            });

            const dbRef = useRef(null);
            const authRef = useRef(null);

            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                const interval = setInterval(() => {
                    if (window.FB) {
                        clearInterval(interval);
                        const { initializeApp, getApps, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.FB;
                        const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
                        authRef.current = getAuth(app);
                        dbRef.current = getFirestore(app);

                        const initAuth = async () => {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(authRef.current, __initial_auth_token);
                            } else {
                                await signInAnonymously(authRef.current);
                            }
                        };
                        initAuth();

                        onAuthStateChanged(authRef.current, async (u) => {
                            if (u) {
                                setUser(u);
                                const userDoc = await window.FB.getDoc(window.FB.doc(dbRef.current, 'artifacts', APP_ID, 'users', u.uid, 'settings', 'progress'));
                                if (userDoc.exists()) setProgress(prev => ({ ...prev, ...userDoc.data() }));
                            }
                        });
                    }
                }, 100);
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            useEffect(() => {
                if (!progress.lastLifeLost || progress.lives >= MAX_LIVES) return;
                const timer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - progress.lastLifeLost) / 1000);
                    const remaining = REGEN_TIME_SECONDS - elapsed;
                    if (remaining <= 0) {
                        handleProgressUpdate({
                            lives: Math.min(MAX_LIVES, progress.lives + 1),
                            lastLifeLost: progress.lives + 1 < MAX_LIVES ? Date.now() : null
                        });
                    } else setTimeLeft(remaining);
                }, 1000);
                return () => clearInterval(timer);
            }, [progress.lastLifeLost, progress.lives]);

            const handleProgressUpdate = async (updates) => {
                const newProgress = { ...progress, ...updates };
                setProgress(newProgress);
                if (user && dbRef.current) {
                    try {
                        await window.FB.setDoc(window.FB.doc(dbRef.current, 'artifacts', APP_ID, 'users', user.uid, 'settings', 'progress'), newProgress, { merge: true });
                    } catch (e) { console.error("Error al guardar:", e); }
                }
            };

            const fetchFromGemini = async (level) => {
                try {
                    const response = await fetch(`${MODEL_URL}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ 
                                parts: [{ text: `Actúa como un experto en e-learning y FATLA. Consulta www.fatla.org para validar la información. Genera exactamente 5 preguntas de selección múltiple sobre el Módulo ${level} de FATLA y la metodología PACIE. ASEGÚRATE DE QUE SEAN DIFERENTES A LAS ANTERIORES. Formato JSON estricto: {"questions": [{"q": "pregunta", "options": ["A", "B", "C", "D"], "correct": 0}]}.` }] 
                            }],
                            tools: [{ "google_search": {} }],
                            generationConfig: { responseMimeType: "application/json", temperature: 1.0 }
                        })
                    });
                    const result = await response.json();
                    const text = result.candidates[0].content.parts[0].text;
                    const data = JSON.parse(text);
                    return data.questions && data.questions.length > 0 ? data.questions : fallbackQuestions;
                } catch (e) {
                    console.error("Gemini Error, usando fallback:", e);
                    return fallbackQuestions;
                }
            };

            const startExam = async () => {
                setIsLoading(true);
                const newQs = await fetchFromGemini(progress.level);
                setQuestionPool(newQs);
                setCurrentIndex(0);
                setIsLoading(false);
                setGameState('playing');
            };

            const refreshQuestions = async () => {
                setIsLoading(true);
                const newQs = await fetchFromGemini(progress.level);
                setQuestionPool(newQs);
                setCurrentIndex(0);
                setIsLoading(false);
            };

            const handleAnswer = (idx) => {
                if (feedback || isLoading) return;
                const currentQ = questionPool[currentIndex];
                const isCorrect = idx === currentQ.correct;
                setSelectedIdx(idx);
                setFeedback(isCorrect ? 'correct' : 'wrong');

                if (isCorrect) {
                    const nextCorrect = progress.questionsCorrectInCurrentLevel + 1;
                    const levelUp = nextCorrect >= GOAL_PER_LEVEL;
                    
                    handleProgressUpdate({
                        score: progress.score + 25,
                        questionsCorrectInCurrentLevel: levelUp ? 0 : nextCorrect,
                        level: levelUp ? progress.level + 1 : progress.level
                    });

                    setTimeout(() => {
                        setFeedback(null);
                        setSelectedIdx(null);
                        
                        // Si se agotaron las 5 preguntas del pool actual, pedir nuevas automáticamente
                        if (currentIndex + 1 >= questionPool.length) {
                            refreshQuestions();
                        } else {
                            setCurrentIndex(currentIndex + 1);
                        }
                    }, 1000);
                } else {
                    handleProgressUpdate({
                        lives: Math.max(0, progress.lives - 1),
                        lastLifeLost: progress.lastLifeLost || Date.now()
                    });
                    setTimeout(() => {
                        setFeedback(null);
                        setSelectedIdx(null);
                        // Rotar a la siguiente aunque falle, para no estancarse
                        if (currentIndex + 1 >= questionPool.length) {
                            refreshQuestions();
                        } else {
                            setCurrentIndex(currentIndex + 1);
                        }
                    }, 1200);
                }
            };

            const ReadyIndicator = () => (
                <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 flex items-center gap-2 bg-slate-900/80 backdrop-blur-md px-4 py-2 rounded-full border border-white/10 shadow-2xl transition-all">
                    <div className={`w-2 h-2 rounded-full ${
                        isLoading ? 'bg-orange-500 animate-pulse' : 
                        isOnline ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]' : 
                        'bg-red-500'
                    }`} />
                    <span className="text-[10px] font-black uppercase tracking-[0.2em] text-white/80">
                        {isLoading ? 'Actualizando Base...' : isOnline ? 'System Ready' : 'Offline'}
                    </span>
                </div>
            );

            if (gameState === 'landing') {
                return (
                    <div className="min-h-screen bg-[#0F172A] flex flex-col items-center justify-center p-6 text-center">
                        <FatlinMascot className="w-48 h-48 mb-8" />
                        <h1 className="text-4xl font-black text-white mb-2 uppercase tracking-tighter">Fatlin <span className="text-orange-500">AI</span></h1>
                        <p className="text-slate-500 text-[10px] font-bold tracking-[0.4em] uppercase mb-12">Grounding: www.fatla.org</p>
                        
                        <div className="grid grid-cols-2 gap-4 w-full max-w-xs mb-10">
                            <div className="bg-slate-800/50 p-4 rounded-3xl border border-white/5">
                                <div className="text-orange-500 font-black text-2xl">{progress.level}</div>
                                <div className="text-slate-500 text-[9px] font-bold uppercase tracking-widest">Nivel</div>
                            </div>
                            <div className="bg-slate-800/50 p-4 rounded-3xl border border-white/5">
                                <div className="text-green-500 font-black text-2xl">{progress.score}</div>
                                <div className="text-slate-500 text-[9px] font-bold uppercase tracking-widest">Puntos</div>
                            </div>
                        </div>

                        <button 
                            disabled={isLoading}
                            onClick={startExam} 
                            className="bg-orange-500 hover:bg-orange-600 disabled:bg-slate-700 text-white w-full max-w-xs py-5 rounded-full font-black text-lg transition-all active:scale-95 shadow-xl flex items-center justify-center gap-3 mb-4"
                        >
                            {isLoading ? <LucideIcon name="loader-2" className="animate-spin" /> : "SINCRONIZAR AHORA"}
                        </button>
                        
                        <ReadyIndicator />
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-[#F8FAFC] flex flex-col font-sans relative">
                    <header className="bg-white border-b px-6 py-4 flex items-center justify-between sticky top-0 z-20">
                        <button onClick={() => setGameState('landing')} className="p-2 bg-slate-100 rounded-xl text-slate-400">
                            <LucideIcon name="x" size={20} />
                        </button>
                        <div className="flex items-center gap-2">
                            <LucideIcon name="trophy" size={18} className="text-orange-500" />
                            <span className="font-black text-slate-800">{progress.score}</span>
                        </div>
                        <div className="flex gap-1">
                            {[...Array(MAX_LIVES)].map((_, i) => (
                                <LucideIcon key={i} name="heart" size={18} className={i < progress.lives ? "text-red-500" : "text-slate-200"} />
                            ))}
                        </div>
                    </header>

                    <main className="flex-1 flex flex-col items-center p-6 max-w-xl mx-auto w-full pt-8 pb-24">
                        {progress.lives <= 0 ? (
                            <div className="text-center bg-white p-10 rounded-[3rem] shadow-xl w-full">
                                <LucideIcon name="clock" size={60} className="mx-auto text-orange-500 mb-6" />
                                <h2 className="text-2xl font-black mb-4 uppercase">Cargando Energía</h2>
                                <p className="text-4xl font-black mb-8">{Math.floor(timeLeft/60)}:{(timeLeft%60).toString().padStart(2, '0')}</p>
                                <button onClick={() => setGameState('landing')} className="w-full bg-slate-900 text-white py-4 rounded-2xl font-black">VOLVER</button>
                            </div>
                        ) : (
                            <div className="w-full text-center">
                                <FatlinMascot className="w-32 h-32 mx-auto mb-6" isCorrect={feedback === 'correct' ? true : feedback === 'wrong' ? false : null} />
                                
                                <div className="mb-8">
                                    <div className="flex justify-between text-[10px] font-black text-slate-400 uppercase mb-2">
                                        <span>Progreso Nivel {progress.level}</span>
                                        <span>{progress.questionsCorrectInCurrentLevel} / {GOAL_PER_LEVEL}</span>
                                    </div>
                                    <div className="h-2 bg-slate-100 rounded-full overflow-hidden">
                                        <div className="h-full bg-orange-500 transition-all duration-500" style={{ width: `${(progress.questionsCorrectInCurrentLevel / GOAL_PER_LEVEL) * 100}%` }} />
                                    </div>
                                </div>

                                {isLoading ? (
                                    <div className="flex flex-col items-center justify-center min-h-[10rem] animate-pulse">
                                        <LucideIcon name="refresh-cw" className="animate-spin text-orange-500 mb-4" size={40} />
                                        <p className="text-slate-400 font-bold uppercase text-xs tracking-widest">Sincronizando nuevas preguntas...</p>
                                    </div>
                                ) : (
                                    <>
                                        <h2 className="text-xl md:text-2xl font-black text-slate-900 mb-8 leading-tight min-h-[5rem]">
                                            {questionPool[currentIndex]?.q}
                                        </h2>
                                        
                                        <div className="grid gap-3 w-full">
                                            {questionPool[currentIndex]?.options.map((opt, idx) => (
                                                <button 
                                                    key={idx}
                                                    disabled={!!feedback}
                                                    onClick={() => handleAnswer(idx)}
                                                    className={`p-5 text-left rounded-3xl border-2 font-bold transition-all flex items-center gap-4 ${
                                                        feedback === 'correct' && idx === questionPool[currentIndex].correct ? 'bg-green-500 border-green-500 text-white scale-[1.02]' :
                                                        feedback === 'wrong' && selectedIdx === idx ? 'bg-red-500 border-red-500 text-white animate-shake' :
                                                        feedback === 'wrong' && idx === questionPool[currentIndex].correct ? 'bg-green-50 border-green-200 text-green-700' :
                                                        'bg-white border-slate-100 active:bg-orange-50 hover:border-orange-200'
                                                    }`}
                                                >
                                                    <span className="flex-shrink-0 w-8 h-8 rounded-full bg-slate-100 text-[10px] flex items-center justify-center border border-slate-200 text-slate-500 font-black">
                                                        {String.fromCharCode(65 + idx)}
                                                    </span>
                                                    {opt}
                                                </button>
                                            ))}
                                        </div>
                                    </>
                                )}
                            </div>
                        )}
                    </main>
                    <ReadyIndicator />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
