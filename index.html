<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fatlin AI - Sincronización FATLA</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0F172A">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2592/2592186.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0F172A; margin: 0; font-family: system-ui, -apple-system, sans-serif; overflow-x: hidden; }
        * { -webkit-tap-highlight-color: transparent; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-15px); } }
        @keyframes pulse-fast { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(5px); } 75% { transform: translateX(-5px); } }
        .animate-float { animation: float 4s ease-in-out infinite; }
        .animate-pulse-fast { animation: pulse-fast 1s infinite; }
        .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.FB = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'fatla-ai-v4';
        const API_KEY = ""; 
        const MODEL_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        
        const MAX_LIVES = 5;
        const REGEN_TIME = 120; 
        const TOTAL_QUESTIONS_TO_LEVEL_UP = 15;

        const SYSTEM_PROMPT = `Eres el experto académico de FATLA. Usa metodología PACIE y fatla.org.
        MODALIDADES DE PREGUNTA:
        1. Selección Múltiple: 4 opciones.
        2. Verdadero o Falso: 2 opciones ("Verdadero", "Falso").
        Alterna entre estas modalidades de forma equilibrada.
        REGLA DE ORO: No repitas NUNCA preguntas anteriores.
        Responde SIEMPRE en este formato JSON: {"questions": [{"q": "pregunta", "options": ["opcion1","opcion2"...], "correct": índice_de_la_correcta}]}`;

        const Icon = ({ name, size = 20, className = "", fill = "none" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name, fill]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-block' }} data-lucide-fill={fill}></i>;
        };

        const Mascot = ({ isCorrect }) => (
            <div className="relative w-36 h-36 mx-auto mb-8">
                <div className={`absolute inset-0 blur-3xl rounded-full transition-all duration-500 ${isCorrect === true ? 'bg-green-500/40' : isCorrect === false ? 'bg-red-500/40' : 'bg-orange-500/20'}`} />
                <svg viewBox="0 0 200 200" className="w-full h-full relative z-10 animate-float">
                    <path d="M40 70 Q40 30 100 30 T160 70 L160 130 Q160 170 100 170 T40 130 Z" fill="#1e293b" stroke="#f97316" strokeWidth="3" />
                    <rect x="60" y="80" width="80" height="40" rx="8" fill="#020617" />
                    <g className="animate-pulse-fast">
                        <circle cx="85" cy="100" r="6" fill={isCorrect === false ? "#ef4444" : "#f97316"} />
                        <circle cx="115" cy="100" r="6" fill={isCorrect === false ? "#ef4444" : "#f97316"} />
                    </g>
                </svg>
            </div>
        );

        function App() {
            const [user, setUser] = useState(null);
            const [gameState, setGameState] = useState('landing');
            const [questions, setQuestions] = useState([]);
            const [currIdx, setCurrIdx] = useState(0);
            const [isLoading, setIsLoading] = useState(false);
            const [feedback, setFeedback] = useState(null); 
            const [wrongAnswers, setWrongAnswers] = useState([]); 
            const [timeLeft, setTimeLeft] = useState(0);
            const [apiError, setApiError] = useState(false);
            const [retryCount, setRetryCount] = useState(0);
            
            const [progress, setProgress] = useState({
                level: 1, score: 0, lives: MAX_LIVES, questionsCorrectInCurrentLevel: 0, lastLifeLost: null, usedQuestions: []
            });

            const dbRef = useRef(null);
            const progressRef = useRef(progress);
            useEffect(() => { progressRef.current = progress; }, [progress]);

            useEffect(() => {
                const init = async () => {
                    if (!window.FB) return;
                    const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                    const app = window.FB.initializeApp(config);
                    const auth = window.FB.getAuth(app);
                    dbRef.current = window.FB.getFirestore(app);
                    
                    window.FB.onAuthStateChanged(auth, async (u) => {
                        if (u) {
                            setUser(u);
                            const docSnap = await window.FB.getDoc(window.FB.doc(dbRef.current, 'artifacts', APP_ID, 'users', u.uid, 'settings', 'progress'));
                            if (docSnap.exists()) setProgress(docSnap.data());
                        } else { 
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await window.FB.signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await window.FB.signInAnonymously(auth); 
                            }
                        }
                    });
                };
                init();
            }, []);

            useEffect(() => {
                if (!progress.lastLifeLost || progress.lives >= MAX_LIVES) return;
                const timer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - progress.lastLifeLost) / 1000);
                    if (elapsed >= REGEN_TIME) {
                        const newLives = progress.lives + 1;
                        saveProgress({ lives: newLives, lastLifeLost: newLives < MAX_LIVES ? Date.now() : null });
                    } else { setTimeLeft(REGEN_TIME - elapsed); }
                }, 1000);
                return () => clearInterval(timer);
            }, [progress.lastLifeLost, progress.lives]);

            const saveProgress = async (updates) => {
                const newProgress = { ...progressRef.current, ...updates };
                setProgress(newProgress);
                if (user && dbRef.current) {
                    try {
                        await window.FB.setDoc(window.FB.doc(dbRef.current, 'artifacts', APP_ID, 'users', user.uid, 'settings', 'progress'), newProgress, { merge: true });
                    } catch (e) { console.warn("Sync error:", e); }
                }
            };

            const fetchQuestions = async (lvl) => {
                setIsLoading(true);
                setFeedback(null);
                setWrongAnswers([]);
                setApiError(false);

                const usedList = progressRef.current.usedQuestions || [];
                const historyText = usedList.slice(-20).join(" | ");
                const userPrompt = `Genera 3 preguntas para Módulo ${lvl}. Evita repetir: [${historyText}]. Variedad entre Selección y V/F.`;

                const delays = [1000, 2000, 4000, 8000, 12000];
                
                for (let i = 0; i < delays.length; i++) {
                    setRetryCount(i);
                    try {
                        const response = await fetch(`${MODEL_URL}?key=${API_KEY}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: userPrompt }] }],
                                systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
                                generationConfig: { responseMimeType: "application/json", temperature: 0.7 }
                            })
                        });

                        if (response.status === 429) throw new Error("RATE_LIMIT");
                        if (!response.ok) throw new Error("FETCH_ERROR");

                        const data = await response.json();
                        const rawJson = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!rawJson) throw new Error("NO_CONTENT");

                        const parsed = JSON.parse(rawJson);
                        if (!parsed.questions) throw new Error("INVALID_FORMAT");

                        setQuestions(parsed.questions);
                        setCurrIdx(0);
                        setGameState('playing');
                        setIsLoading(false);
                        return;
                    } catch (err) {
                        console.log(`Intento ${i + 1} fallido. Reintentando...`);
                        if (i === delays.length - 1) {
                            setApiError(true);
                            setIsLoading(false);
                        } else {
                            await new Promise(resolve => setTimeout(resolve, delays[i]));
                        }
                    }
                }
            };

            const handleAnswer = (idx) => {
                if (feedback || progressRef.current.lives <= 0) return;
                
                const currentQuestion = questions[currIdx];
                const isCorrect = idx === currentQuestion.correct;
                const newUsed = Array.from(new Set([...(progressRef.current.usedQuestions || []), currentQuestion.q])).slice(-100);

                if (isCorrect) {
                    setFeedback('correct');
                    const nextCount = progressRef.current.questionsCorrectInCurrentLevel + 1;
                    const isLevelUp = nextCount >= TOTAL_QUESTIONS_TO_LEVEL_UP;

                    setTimeout(() => {
                        const updates = {
                            score: progressRef.current.score + 25,
                            questionsCorrectInCurrentLevel: isLevelUp ? 0 : nextCount,
                            level: isLevelUp ? progressRef.current.level + 1 : progressRef.current.level,
                            usedQuestions: newUsed
                        };
                        saveProgress(updates);
                        setFeedback(null);
                        setWrongAnswers([]);

                        if (isLevelUp || (currIdx + 1) >= questions.length) {
                            fetchQuestions(updates.level);
                        } else { setCurrIdx(prev => prev + 1); }
                    }, 1000);
                } else {
                    setFeedback('wrong');
                    setWrongAnswers(prev => [...prev, idx]);
                    const currentLives = progressRef.current.lives;
                    const newLives = Math.max(0, currentLives - 1);
                    
                    saveProgress({
                        lives: newLives,
                        lastLifeLost: currentLives === MAX_LIVES ? Date.now() : progressRef.current.lastLifeLost,
                        usedQuestions: newUsed
                    });

                    setTimeout(() => {
                        setFeedback(null);
                        if (newLives > 0) {
                            if ((currIdx + 1) < questions.length) {
                                setCurrIdx(prev => prev + 1);
                                setWrongAnswers([]);
                            } else {
                                fetchQuestions(progressRef.current.level);
                            }
                        }
                    }, 1000);
                }
            };

            if (gameState === 'landing') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-8 text-center bg-[#0F172A] text-white">
                        <Mascot />
                        <h1 className="text-5xl font-black mb-2 italic tracking-tighter uppercase">Fatlin <span className="text-orange-500">AI</span></h1>
                        <p className="text-slate-400 text-[10px] font-bold uppercase tracking-[0.4em] mb-12 italic">Sincronización PACIE v4.6</p>
                        
                        <div className="grid grid-cols-2 gap-4 w-full max-w-xs mb-10">
                            <div className="bg-slate-800/40 p-5 rounded-[2rem] border border-white/5 shadow-inner">
                                <div className="text-orange-500 text-3xl font-black">{progress.level}</div>
                                <div className="text-[10px] uppercase font-bold text-slate-500 mt-1">Módulo</div>
                            </div>
                            <div className="bg-slate-800/40 p-5 rounded-[2rem] border border-white/5 shadow-inner">
                                <div className="text-green-500 text-3xl font-black">{progress.score}</div>
                                <div className="text-[10px] uppercase font-bold text-slate-500 mt-1">Puntos</div>
                            </div>
                        </div>

                        <button 
                            disabled={isLoading}
                            onClick={() => fetchQuestions(progress.level)} 
                            className="w-full max-w-xs bg-orange-500 py-6 rounded-full font-black text-xl shadow-[0_20px_50px_rgba(249,115,22,0.4)] active:scale-95 transition-all flex items-center justify-center gap-3"
                        >
                            {isLoading ? (
                                <>
                                    <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                    {retryCount > 0 ? `REINTENTANDO (${retryCount})...` : 'CONECTANDO...'}
                                </>
                            ) : "EMPEZAR RETO"}
                        </button>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-[#F8FAFC] flex flex-col">
                    <header className="bg-white border-b p-5 flex justify-between items-center sticky top-0 z-20 shadow-sm">
                        <button onClick={() => setGameState('landing')} className="text-slate-400 p-2 bg-slate-50 rounded-xl active:bg-slate-100 transition-colors">
                            <Icon name="x" size={20} />
                        </button>
                        <div className="flex gap-1.5 px-4 py-2 bg-slate-50 rounded-full border border-slate-100">
                            {[...Array(MAX_LIVES)].map((_, i) => (
                                <Icon key={i} name="heart" size={18} fill={i < progress.lives ? "#EF4444" : "none"} className={i < progress.lives ? "text-red-500" : "text-slate-200"} />
                            ))}
                        </div>
                    </header>

                    <main className="flex-1 p-6 max-w-xl mx-auto w-full flex flex-col">
                        {apiError ? (
                            <div className="flex-1 flex flex-col items-center justify-center text-center p-4">
                                <div className="w-20 h-20 bg-orange-50 rounded-full flex items-center justify-center mb-6">
                                    <Icon name="wifi-off" size={40} className="text-orange-500" />
                                </div>
                                <h2 className="text-2xl font-black text-slate-800 mb-2">IA SATURADA</h2>
                                <p className="text-slate-500 mb-8 italic text-sm">El experto de FATLA está atendiendo a muchos usuarios. Intenta reconectar.</p>
                                <button onClick={() => fetchQuestions(progress.level)} className="bg-orange-500 text-white px-10 py-5 rounded-full font-bold shadow-lg active:scale-95 transition-all">REINTENTAR AHORA</button>
                            </div>
                        ) : progress.lives <= 0 && feedback !== 'correct' ? (
                            <div className="flex-1 flex flex-col items-center justify-center text-center animate-in fade-in zoom-in duration-300">
                                <div className="w-24 h-24 bg-red-50 rounded-full flex items-center justify-center mb-6 border border-red-100">
                                    <Icon name="battery-warning" size={48} className="text-red-500" />
                                </div>
                                <h2 className="text-3xl font-black text-slate-800 mb-2 uppercase tracking-tight">Vínculo Perdido</h2>
                                <p className="text-slate-500 mb-8 text-sm px-4 italic font-medium">Energía académica agotada. Espera la restauración de la señal.</p>
                                <div className="text-6xl font-black text-slate-900 mb-10 bg-white shadow-xl px-12 py-8 rounded-[3rem] border border-slate-100 font-mono tracking-tighter">
                                    {Math.floor(timeLeft/60)}:{(timeLeft%60).toString().padStart(2, '0')}
                                </div>
                                <button onClick={() => setGameState('landing')} className="w-full bg-slate-900 text-white py-5 rounded-[2rem] font-black uppercase tracking-widest shadow-lg active:scale-95 transition-all">Cerrar Sesión</button>
                            </div>
                        ) : (
                            <div className="w-full text-center">
                                <Mascot isCorrect={feedback === 'correct' ? true : (feedback === 'wrong' || wrongAnswers.length > 0) ? false : null} />
                                
                                <div className="mb-10 w-full max-w-sm mx-auto">
                                    <div className="flex justify-between text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                        <span>PROGRESO MÓDULO {progress.level}</span>
                                        <span className="text-orange-500">{progress.questionsCorrectInCurrentLevel} / {TOTAL_QUESTIONS_TO_LEVEL_UP}</span>
                                    </div>
                                    <div className="h-2.5 bg-slate-200 rounded-full overflow-hidden shadow-inner border border-slate-300/20">
                                        <div className="h-full bg-orange-500 transition-all duration-700 ease-out" style={{ width: `${(progress.questionsCorrectInCurrentLevel / TOTAL_QUESTIONS_TO_LEVEL_UP) * 100}%` }} />
                                    </div>
                                </div>

                                <h2 className="text-2xl font-black text-slate-800 mb-10 leading-tight min-h-[100px] flex items-center justify-center px-4">
                                    {isLoading ? (
                                        <div className="flex flex-col items-center gap-4">
                                            <div className="w-10 h-10 border-4 border-orange-500 border-t-transparent rounded-full animate-spin"></div>
                                            <span className="text-[10px] text-slate-400 uppercase tracking-[0.3em] font-black">Sincronizando Módulo...</span>
                                        </div>
                                    ) : questions[currIdx]?.q}
                                </h2>

                                <div className={`grid gap-3.5 w-full ${questions[currIdx]?.options.length === 2 ? 'grid-cols-2' : 'grid-cols-1'}`}>
                                    {!isLoading && questions[currIdx]?.options.map((opt, i) => {
                                        const isWrong = wrongAnswers.includes(i);
                                        const isCorrectVisual = feedback === 'correct' && i === questions[currIdx].correct;
                                        const isTwoOptions = questions[currIdx]?.options.length === 2;
                                        
                                        return (
                                            <button 
                                                key={`${currIdx}-${i}`} 
                                                disabled={feedback || isWrong || isLoading} 
                                                onClick={() => handleAnswer(i)} 
                                                className={`p-5 text-left rounded-[2rem] border-2 font-bold transition-all flex items-center gap-4 group relative ${
                                                    isCorrectVisual ? 'bg-green-500 border-green-500 text-white scale-[1.03] shadow-xl z-10' : 
                                                    isWrong ? 'bg-red-50 border-red-100 text-red-300 opacity-40 animate-shake' : 
                                                    'bg-white border-slate-100 active:bg-slate-50 active:scale-[0.98]'
                                                } ${isTwoOptions ? 'justify-center flex-col py-8' : ''}`}
                                            >
                                                <div className={`rounded-full flex items-center justify-center text-[10px] font-black border transition-colors ${
                                                    isCorrectVisual ? 'bg-white/20 border-white text-white' : 
                                                    isWrong ? 'bg-red-100 border-red-200 text-red-400' : 
                                                    'bg-slate-50 border-slate-200 text-slate-400'
                                                } ${isTwoOptions ? 'w-12 h-12 text-base' : 'w-9 h-9'}`}>
                                                    {isTwoOptions ? (opt.toLowerCase().startsWith('v') ? <Icon name="check" size={20} /> : <Icon name="x" size={20} />) : String.fromCharCode(65 + i)}
                                                </div>
                                                <span className={`${isTwoOptions ? 'text-center font-black uppercase tracking-widest text-sm' : 'flex-1 text-sm md:text-base'}`}>{opt}</span>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
